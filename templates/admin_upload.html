<script>
let files = []
const MAX = 30

const drop = document.querySelector(".drop")

// CLICK SELECT
file.onchange = e => {
  files = [...e.target.files]
  updateCount()
}

// PREVENT BROWSER DEFAULT
;["dragenter","dragover","dragleave","drop"].forEach(ev=>{
  drop.addEventListener(ev,e=>e.preventDefault())
})

// DRAG VISUAL
drop.addEventListener("dragover",()=>{
  drop.style.background = "#eef2ff"
})
drop.addEventListener("dragleave",()=>{
  drop.style.background = ""
})

// DROP FILES
drop.addEventListener("drop", e=>{
  files = [...e.dataTransfer.files]
  drop.style.background = ""
  updateCount()
})

function updateCount(){
  count.innerText = files.length + " files selected"
  warn.innerText = ""

  if(files.length > MAX){
    warn.innerText = "âš  Max 30 photos per upload. Please upload in batches."
  }
}

function upload(){
  if(files.length === 0){
    alert("Please select files first")
    return
  }

  if(files.length > MAX){
    alert("Too many files. Upload max 30 at once.")
    return
  }

  bar.value = 0
  stats.style.display = "none"

  let form = new FormData()
  files.forEach(f => form.append("photos", f))

  let xhr = new XMLHttpRequest()
  xhr.open("POST", "/admin/upload")

  xhr.upload.onprogress = e => {
    if(e.lengthComputable){
      bar.value = (e.loaded / e.total) * 100
    }
  }

  xhr.onload = () => {
    alert(xhr.responseText)

    let txt = xhr.responseText
    let u = txt.match(/Uploaded:\s*(\d+)/)
    let i = txt.match(/Indexed.*:\s*(\d+)/)
    let n = txt.match(/No face.*:\s*(\d+)/)

    if(u){
      stats.style.display = "block"
      up.innerText = u[1]
      idx.innerText = i ? i[1] : 0
      noface.innerText = n ? n[1] : 0
    }
  }

  xhr.send(form)
}
</script>
